<<<<<<< HEAD
var GLMap=function(a){function b(a,b,c){return Math.min(c,Math.max(a,b))}function c(a,b,c){var d=b/360+.5,e=Math.min(1,Math.max(0,.5-Math.log(Math.tan(Math.PI/4+Math.PI/2*a/180))/Math.PI/2));return{x:d*c,y:e*c}}function d(a,b,c){return a/=c,b/=c,{latitude:(2*Math.atan(Math.exp(Math.PI*(1-2*b)))-Math.PI/2)*(180/Math.PI),longitude:360*a-180}}var e,f=function(a){function b(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a}function c(a,b){return Math.min(b,Math.max(0,a))}var d={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",grey:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#ffa500",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00"},e=function(a,b,c,d){this.H=a,this.S=b,this.L=c,this.A=d};return e.parse=function(a){var b,c=0,e=0,f=0,g=1;if(a=(""+a).toLowerCase(),a=d[a]||a,b=a.match(/^#(\w{2})(\w{2})(\w{2})$/))c=parseInt(b[1],16),e=parseInt(b[2],16),f=parseInt(b[3],16);else{if(!(b=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/)))return;c=parseInt(b[1],10),e=parseInt(b[2],10),f=parseInt(b[3],10),g=b[4]?parseFloat(b[5]):1}return this.fromRGBA(c,e,f,g)},e.fromRGBA=function(a,b,c,d){"object"==typeof a?(b=a.g/255,c=a.b/255,d=a.a,a=a.r/255):(a/=255,b/=255,c/=255);var f,g,h=Math.max(a,b,c),i=Math.min(a,b,c),j=(h+i)/2,k=h-i;if(k){switch(g=j>.5?k/(2-h-i):k/(h+i),h){case a:f=(b-c)/k+(c>b?6:0);break;case b:f=(c-a)/k+2;break;case c:f=(a-b)/k+4}f*=60}else f=g=0;return new e(f,g,j,d)},e.prototype={toRGBA:function(){var a=c(this.H,360),d=c(this.S,1),e=c(this.L,1),f={a:c(this.A,1)};if(0===d)f.r=e,f.g=e,f.b=e;else{var g=.5>e?e*(1+d):e+d-e*d,h=2*e-g;a/=360,f.r=b(h,g,a+1/3),f.g=b(h,g,a),f.b=b(h,g,a-1/3)}return{r:Math.round(255*f.r),g:Math.round(255*f.g),b:Math.round(255*f.b),a:f.a}},toString:function(){var a=this.toRGBA();return 1===a.a?"#"+((1<<24)+(a.r<<16)+(a.g<<8)+a.b).toString(16).slice(1,7):"rgba("+[a.r,a.g,a.b,a.a.toFixed(2)].join(",")+")"},hue:function(a){return new e(this.H*a,this.S,this.L,this.A)},saturation:function(a){return new e(this.H,this.S*a,this.L,this.A)},lightness:function(a){return new e(this.H,this.S,this.L*a,this.A)},alpha:function(a){return new e(this.H,this.S,this.L,this.A*a)}},e}(this),g=function(a){var b,c={};return c.View=function(a,c,d){var e=s.createElement("CANVAS");e.style.position="absolute",e.width=c,e.height=d,a.appendChild(e);var f={antialias:!0,depth:!0,premultipliedAlpha:!1};try{b=e.getContext("webgl",f)}catch(g){}if(!b)try{b=e.getContext("experimental-webgl",f)}catch(g){}if(!b)throw new Error("WebGL not supported");return b.viewport(0,0,c,d),b.cullFace(b.BACK),b.enable(b.CULL_FACE),b.enable(b.DEPTH_TEST),b.clearColor(.5,.5,.5,1),b},c.start=function(a){return setInterval(function(){requestAnimationFrame(a)},17)},c.stop=function(a){clearInterval(a)},c.destroy=function(a){a.canvas.parentNode.removeChild(a.canvas),a.canvas=null},c.util={},c.util.nextPowerOf2=function(a){return a--,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,a++,a},c.util.calcNormal=function(a,b,c,d,e,f,g,h,i){var j=a-d,k=b-e,l=c-f,m=d-g,n=e-h,o=f-i,p=k*o-l*n,q=l*m-j*o,r=j*n-k*m;return this.calcUnit(p,q,r)},c.util.calcUnit=function(a,b,c){var d=Math.sqrt(a*a+b*b+c*c);return 0===d&&(d=1e-5),[a/d,b/d,c/d]},c.Buffer=function(a,c){this.id=b.createBuffer(),this.itemSize=a,this.numItems=c.length/a,b.bindBuffer(b.ARRAY_BUFFER,this.id),b.bufferData(b.ARRAY_BUFFER,c,b.STATIC_DRAW),c=null},c.Buffer.prototype={enable:function(){b.bindBuffer(b.ARRAY_BUFFER,this.id)},destroy:function(){b.deleteBuffer(this.id)}},c.Framebuffer=function(a,b){this.setSize(a,b)},c.Framebuffer.prototype={setSize:function(a,d){this.frameBuffer=b.createFramebuffer(),b.bindFramebuffer(b.FRAMEBUFFER,this.frameBuffer),this.width=a,this.height=d;var e=c.util.nextPowerOf2(Math.max(this.width,this.height));if(this.renderBuffer=b.createRenderbuffer(),b.bindRenderbuffer(b.RENDERBUFFER,this.renderBuffer),b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,e,e),this.renderTexture&&this.renderTexture.destroy(),this.renderTexture=new c.Texture({size:e}),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,this.renderBuffer),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.renderTexture.id,0),b.checkFramebufferStatus(b.FRAMEBUFFER)!==b.FRAMEBUFFER_COMPLETE)throw new Error("This combination of framebuffer attachments does not work");b.bindRenderbuffer(b.RENDERBUFFER,null),b.bindFramebuffer(b.FRAMEBUFFER,null)},enable:function(){b.bindFramebuffer(b.FRAMEBUFFER,this.frameBuffer),b.bindRenderbuffer(b.RENDERBUFFER,this.renderBuffer)},disable:function(){b.bindFramebuffer(b.FRAMEBUFFER,null),b.bindRenderbuffer(b.RENDERBUFFER,null)},getData:function(){var a=new Uint8Array(this.width*this.height*4);return b.readPixels(0,0,this.width,this.height,b.RGBA,b.UNSIGNED_BYTE,a),a},destroy:function(){this.renderTexture&&this.renderTexture.destroy()}},c.Shader=function(a){if(this.id=b.createProgram(),this.attach(b.VERTEX_SHADER,a.vertexShader),this.attach(b.FRAGMENT_SHADER,a.fragmentShader),b.linkProgram(this.id),!b.getProgramParameter(this.id,b.LINK_STATUS))throw new Error(b.getProgramParameter(this.id,b.VALIDATE_STATUS)+"\n"+b.getError());this.attributeNames=a.attributes,this.uniformNames=a.uniforms,a.framebuffer&&(this.framebuffer=new c.Framebuffer)},c.Shader.prototype={locateAttribute:function(a){var c=b.getAttribLocation(this.id,a);return 0>c?void console.error('unable to locate attribute "'+a+'" in shader'):(b.enableVertexAttribArray(c),void(this.attributes[a]=c))},locateUniform:function(a){var c=b.getUniformLocation(this.id,a);return 0>c?void console.error('unable to locate uniform "'+a+'" in shader'):void(this.uniforms[a]=c)},attach:function(a,c){var d=b.createShader(a);if(b.shaderSource(d,c),b.compileShader(d),!b.getShaderParameter(d,b.COMPILE_STATUS))throw new Error(b.getShaderInfoLog(d));b.attachShader(this.id,d)},enable:function(){b.useProgram(this.id);var a;if(this.attributeNames)for(this.attributes={},a=0;a<this.attributeNames.length;a++)this.locateAttribute(this.attributeNames[a]);if(this.uniformNames)for(this.uniforms={},a=0;a<this.uniformNames.length;a++)this.locateUniform(this.uniformNames[a]);return this.framebuffer&&this.framebuffer.enable(),this},disable:function(){if(this.attributes)for(var a in this.attributes)b.disableVertexAttribArray(this.attributes[a]);this.attributes=null,this.uniforms=null,this.framebuffer&&this.framebuffer.disable()}},c.Matrix=function(a){a?this.data=new Float32Array(a):this.identity()},function(){function a(a){return a*Math.PI/180}function b(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return new Float32Array([c*s+d*w+e*A+f*E,c*t+d*x+e*B+f*F,c*u+d*y+e*C+f*G,c*v+d*z+e*D+f*H,g*s+h*w+i*A+j*E,g*t+h*x+i*B+j*F,g*u+h*y+i*C+j*G,g*v+h*z+i*D+j*H,k*s+l*w+m*A+n*E,k*t+l*x+m*B+n*F,k*u+l*y+m*C+n*G,k*v+l*z+m*D+n*H,o*s+p*w+q*A+r*E,o*t+p*x+q*B+r*F,o*u+p*y+q*C+r*G,o*v+p*z+q*D+r*H])}c.Matrix.prototype={identity:function(){return this.data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this},multiply:function(a){return this.data=b(this.data,a.data),this},translate:function(a,c,d){return this.data=b(this.data,[1,0,0,0,0,1,0,0,0,0,1,0,a,c,d,1]),this},rotateX:function(c){var d=a(c),e=Math.cos(d),f=Math.sin(d);return this.data=b(this.data,[1,0,0,0,0,e,f,0,0,-f,e,0,0,0,0,1]),this},rotateY:function(c){var d=a(c),e=Math.cos(d),f=Math.sin(d);return this.data=b(this.data,[e,0,-f,0,0,1,0,0,f,0,e,0,0,0,0,1]),this},rotateZ:function(c){var d=a(c),e=Math.cos(d),f=Math.sin(d);return this.data=b(this.data,[e,-f,0,0,f,e,0,0,0,0,1,0,0,0,0,1]),this},scale:function(a,c,d){return this.data=b(this.data,[a,0,0,0,0,c,0,0,0,0,d,0,0,0,0,1]),this}},c.Matrix.multiply=function(a,c){return b(a.data,c.data)},c.Matrix.Perspective=function(a,b,d,e){var f=1/Math.tan(a*(Math.PI/180)/2),g=1/(d-e);return new c.Matrix([f/b,0,0,0,0,f,0,0,0,0,(e+d)*g,-1,0,0,2*e*d*g,0])},c.Matrix.invert3=function(a){var b=a[0],c=a[1],d=a[2],e=a[4],f=a[5],g=a[6],h=a[8],i=a[9],j=a[10],k=j*f-g*i,l=-j*e+g*h,m=i*e-f*h,n=b*k+c*l+d*m;return n?(n=1/n,[k*n,(-j*c+d*i)*n,(g*c-d*f)*n,l*n,(j*b-d*h)*n,(-g*b+d*e)*n,m*n,(-i*b+c*h)*n,(f*b-c*e)*n]):null},c.Matrix.transpose=function(a){return new Float32Array([a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]])},c.Matrix.transform=function(a){var b=a[12],c=a[13],d=a[15];return{x:(b/d+1)/2,y:(c/d+1)/2}}}(),c.Texture=function(a){a=a||{},this.id=b.createTexture(),b.bindTexture(b.TEXTURE_2D,this.id),a.size?(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,a.size,a.size,0,b.RGBA,b.UNSIGNED_BYTE,null)):(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,a.filter||b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR_MIPMAP_NEAREST),a.image&&this.setImage(a.image),b.bindTexture(b.TEXTURE_2D,null))},c.Texture.prototype={enable:function(a){b.bindTexture(b.TEXTURE_2D,this.id),b.activeTexture(b.TEXTURE0+(a||0))},disable:function(){b.bindTexture(b.TEXTURE_2D,null)},load:function(a,c){var d=this.image=new Image;d.crossOrigin="*",d.onload=function(){var a=b.getParameter(b.MAX_TEXTURE_SIZE);if(d.width>a||d.height>a){var e=a,f=a,g=d.width/d.height;1>g?e=Math.round(f*g):f=Math.round(e/g);var h=s.createElement("CANVAS");h.width=e,h.height=f;var i=h.getContext("2d");i.drawImage(d,0,0,h.width,h.height),d=h}this.setImage(d),this.isLoaded=!0,c&&c(d)}.bind(this),d.onerror=function(){c&&c()},d.src=a},setImage:function(a){b.bindTexture(b.TEXTURE_2D,this.id),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a),b.generateMipmap(b.TEXTURE_2D),a=null},destroy:function(){b.bindTexture(b.TEXTURE_2D,null),b.deleteTexture(this.id),this.image&&(this.isLoaded=null,this.image.src="",this.image=null)}},c.mesh={},c.mesh.addQuad=function(a,b,c,d,e,f){this.addTriangle(a,b,c,d,f),this.addTriangle(a,d,e,b,f)},c.mesh.addTriangle=function(a,b,d,e,f){a.vertices.push(b[0],b[1],b[2],d[0],d[1],d[2],e[0],e[1],e[2]);var g=c.util.calcNormal(b[0],b[1],b[2],d[0],d[1],d[2],e[0],e[1],e[2]);a.normals.push(g[0],g[1],g[2],g[0],g[1],g[2],g[0],g[1],g[2]),a.colors.push(f[0],f[1],f[2],f[3],f[0],f[1],f[2],f[3],f[0],f[1],f[2],f[3])},c.mesh.Triangle=function(a,b){var d={vertices:[],normals:[],colors:[]},e=[-a/2,-a/2,0],f=[a/2,-a/2,0],g=[a/2,a/2,0];c.mesh.addTriangle(d,e,f,g,b),this.vertexBuffer=new c.Buffer(3,new Float32Array(d.vertices)),this.normalBuffer=new c.Buffer(3,new Float32Array(d.normals)),this.colorBuffer=new c.Buffer(4,new Float32Array(d.colors)),this.transform=new c.Matrix},c.mesh.Plane=function(a,b){var d={vertices:[],normals:[],colors:[]},e=[-a/2,-a/2,0],f=[a/2,-a/2,0],g=[a/2,a/2,0],h=[-a/2,a/2,0];c.mesh.addQuad(d,e,f,g,h,b),this.vertexBuffer=new c.Buffer(3,new Float32Array(d.vertices)),this.normalBuffer=new c.Buffer(3,new Float32Array(d.normals)),this.colorBuffer=new c.Buffer(4,new Float32Array(d.colors)),this.transform=new c.Matrix},c.mesh.Cube=function(a,b){var d={vertices:[],normals:[],colors:[]},e=[-a/2,-a/2,-a/2],f=[a/2,-a/2,-a/2],g=[a/2,a/2,-a/2],h=[-a/2,a/2,-a/2],i=[-a/2,-a/2,a/2],j=[a/2,-a/2,a/2],k=[a/2,a/2,a/2],l=[-a/2,a/2,a/2];c.mesh.addQuad(d,e,f,g,h,b),c.mesh.addQuad(d,i,j,k,l,b),c.mesh.addQuad(d,e,f,j,i,b),c.mesh.addQuad(d,f,g,k,j,b),c.mesh.addQuad(d,g,h,l,k,b),c.mesh.addQuad(d,h,e,i,l,b),this.vertexBuffer=new c.Buffer(3,new Float32Array(d.vertices)),this.normalBuffer=new c.Buffer(3,new Float32Array(d.normals)),this.colorBuffer=new c.Buffer(4,new Float32Array(d.colors)),this.transform=new c.Matrix},c}(this),h=0,i=0,j=function(a,b){b=b||{};var c=s.getElementById(a);this.attribution=s.createElement("DIV"),this.attribution.setAttribute("style","position:absolute;right:0;bottom:0;padding:1px 3px;background:rgba(255,255,255,0.5);font:11px sans-serif"),this.attribution.innerHTML=this.attributionPrefix=b.attribution||"",c.appendChild(this.attribution),h=c.offsetWidth,i=c.offsetHeight,e=new g.View(c,h,i),l.init(c),k.on("resize",function(){this.setSize(c.offsetWidth,c.offsetHeight)}.bind(this)),Renderer.start(b.backgroundColor),this.setDisabled(b.disabled)};j.prototype={addLayer:function(a){return o.add(a),this.attribution.innerHTML=o.getAttributions([this.attributionPrefix]).join(" &middot; "),this},removeLayer:function(a){o.remove(a),this.attribution.innerHTML=o.getAttributions([this.attributionPrefix]).join(" &middot; ")},on:function(a,b){return k.on(a,b),this},off:function(a,b){return k.off(a,b),this},setDisabled:function(a){return l.setDisabled(a),this},isDisabled:function(){return!!l.isDisabled},setZoom:function(a){return n.setZoom(a),this},getZoom:function(){return n.zoom},setPosition:function(a){return n.setPosition(a),this},getPosition:function(){return n.getPosition()},getBounds:function(){return n.getBounds()},setSize:function(a){return(a.width!==h||a.height!==i)&&(e.canvas.width=h=a.width,e.canvas.height=i=a.height,k.emit("resize")),this},getSize:function(){return{width:h,height:i}},setRotation:function(a){return n.setRotation(a),this},getRotation:function(){return n.rotation},setTilt:function(a){return n.setTilt(a),this},getTilt:function(){return n.tilt},transform:function(a,b,d){var e=(c(a,b,r*Math.pow(2,n.zoom)),new g.Matrix,g.Matrix.multiply({data:mv},Renderer.perspective)),f=g.Matrix.transform(e);return{x:f.x*h,y:i-f.y*i}},destroy:function(){g.destroy(e),Renderer.destroy(),o.destroy(),k.destroy(),l.destroy()}};var k={};!function(){var a={};k.on=function(b,c){a[b]||(a[b]=[]),a[b].push(c)},k.off=function(b,c){if(a[b])for(var d=0,e=a[b].length;e>d;d++)a[b][d]===c&&a[b].splice(d,1)},k.emit=function(b,c){if(a[b])for(var d=0,e=a[b].length;e>d;d++)a[b][d](c)},k.destroy=function(){a=null}}();var l={};!function(){function b(a,b,c){a.addEventListener(b,c,!1)}function c(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.returnValue=!1}function d(a){if(!(l.isDisabled||a.button>1)){if(c(a),x=n.zoom,y=n.rotation,z=n.tilt,q=360/innerWidth,r=360/innerHeight,void 0===a.touches)p=a.button;else{if(a.touches.length>1)return;a=a.touches[0]}v=t=a.clientX,w=u=a.clientY,A=!0}}function e(a){if(!l.isDisabled&&A){if(void 0!==a.touches){if(a.touches.length>1)return;a=a.touches[0]}void 0===a.touches&&0!==p||a.altKey?(y+=(a.clientX-t)*q,z-=(a.clientY-u)*r,n.setRotation(y),n.setTilt(z)):m(a),t=a.clientX,u=a.clientY}}function f(a){if(!l.isDisabled&&A){if(void 0!==a.touches){if(a.touches.length>1)return;a=a.touches[0]}void 0===a.touches&&0!==p||a.altKey?(y+=(a.clientX-t)*q,z-=(a.clientY-u)*r,n.setRotation(y),n.setTilt(z)):Math.abs(a.clientX-v)<5&&Math.abs(a.clientY-w)<5?i(a):m(a),A=!1}}function g(a){l.isDisabled||(c(a),n.setZoom(x+(a.scale-1)),n.setRotation(y-a.rotation))}function h(a){l.isDisabled||(c(a),n.setZoom(n.zoom+1,a))}function i(a){l.isDisabled||c(a)}function j(a){if(!l.isDisabled){c(a);var b=0;a.wheelDeltaY?b=a.wheelDeltaY:a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail);var d=.2*(b>0?1:0>b?-1:0);n.setZoom(n.zoom+d,a)}}function m(a){var b=a.clientX-t,c=a.clientY-u;o(b,c,n.rotation*Math.PI/180)}function o(a,b,c){return{x:Math.cos(c)*a-Math.sin(c)*b,y:Math.sin(c)*a+Math.cos(c)*b}}var p,q,r,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=!1;l.init=function(c){var i="ontouchstart"in a;b(c,i?"touchstart":"mousedown",d),b(c,"dblclick",h),b(s,i?"touchmove":"mousemove",e),b(s,i?"touchend":"mouseup",f),i?b(c,"gesturechange",g):(b(c,"mousewheel",j),b(c,"DOMMouseScroll",j));var l;b(a,"resize",function(){clearTimeout(l),l=setTimeout(function(){k.emit("resize")},250)})},l.setDisabled=function(a){l.isDisabled=!!a},l.destroy=function(){}}();var m={};!function(){var a=[];m.setBusy=function(b){a.length||k.emit("busy"),-1===a.indexOf(b)&&a.push(b)},m.setIdle=function(b){if(a.length){var c=a.indexOf(b);c>-1&&a.splice(c,1),a.length||k.emit("idle")}}}();var n={zoom:0,center:{x:0,y:0},bounds:{minX:0,maxX:0,minY:0,maxY:0},rotation:0,tilt:0,setZoom:function(a,c){if(a=b(parseFloat(a),this.minZoom,this.maxZoom),this.zoom!==a){var d=Math.pow(2,a-this.zoom);if(this.zoom=a,c){var e=h/2-c.clientX,f=i/2-c.clientY;this.center.x-=e,this.center.y-=f,this.center.x*=d,this.center.y*=d,this.center.x+=e,this.center.y+=f}else this.center.x*=d,this.center.y*=d;k.emit("change")}return this},setPosition:function(a){var d=b(parseFloat(a.latitude),-90,90),e=b(parseFloat(a.longitude),-180,180),f=c(d,e,r*Math.pow(2,this.zoom));return(this.center.x!==f.x||this.center.y!==f.y)&&(this.center.x=f.x,this.center.y=f.y,k.emit("change")),this},getPosition:function(){return d(this.center.x,this.center.y,r*Math.pow(2,this.zoom))},getBounds:function(){var a=r*Math.pow(2,this.zoom),b=d(this.bounds.minX,this.bounds.maxY,a),c=d(this.bounds.maxX,this.bounds.minY,a);return{n:b.latitude,w:b.longitude,s:c.latitude,e:c.longitude}},setRotation:function(a){return a=parseFloat(a)%360,this.rotation!==a&&(this.rotation=a,k.emit("change")),this},setTilt:function(a){return a=b(parseFloat(a),0,90),this.tilt!==a&&(this.tilt=a,k.emit("change")),this},destroy:function(){}},o={items:[],add:function(a){this.items.push(a)},remove:function(a){this.attribution=[];for(var b=0;b<this.items.length;b++)this.items[b]===a&&this.items.splice(b,1)},getAttributions:function(a){for(var b=0;b<this.items.length;b++)this.items[b].attribution&&a.push(this.items[b].attribution);return a},render:function(a){for(var b=0;b<this.items.length;b++)this.items[b].render(a)},destroy:function(){for(var a=0;a<this.items.length;a++)this.items[a].destroy&&this.items[a].destroy();this.items=null}};Renderer={start:function(a){this.resize(),k.on("resize",this.resize.bind(this));var b=f.parse(a||"#cccccc").toRGBA();this.backgroundColor={r:b.r/255,g:b.g/255,b:b.b/255},e.cullFace(e.BACK),e.disable(e.CULL_FACE),e.enable(e.DEPTH_TEST),g.start(function(){n.transform=new g.Matrix,n.transform.rotateZ(n.rotation),n.transform.rotateX(n.tilt),n.transform.translate(0,0,-300);var a=new g.Matrix(g.Matrix.multiply(n.transform,this.perspective));e.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),o.render(a)}.bind(this))},resize:function(){this.perspective=new g.Matrix.Perspective(45,h/i,.1,1e3),e.viewport(0,0,h,i)},destroy:function(){g.stop()}};var p={};!function(){function a(a){if(history.replaceState){var b=[],c=a.getPosition();b.push("lat="+c.latitude.toFixed(5)),b.push("lon="+c.longitude.toFixed(5)),b.push("zoom="+a.zoom.toFixed(1)),b.push("tilt="+a.tilt.toFixed(1)),b.push("rotation="+a.rotation.toFixed(1)),history.replaceState({},"","?"+b.join("&"))}}p.load=function(a){var b=location.search;if(b){var c={};b=b.substring(1).replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(a,b,d){b&&(c[b]=d)}),void 0!==c.lat&&void 0!==c.lon&&(a.position={latitude:parseFloat(c.lat),longitude:parseFloat(c.lon)}),void 0!==c.zoom&&(a.zoom=parseFloat(c.zoom)),void 0!==c.rotation&&(a.rotation=parseFloat(c.rotation)),void 0!==c.tilt&&(a.tilt=parseFloat(c.tilt))}return a};var b;p.save=function(c){clearTimeout(b),b=setTimeout(function(){a(c)},1e3)},k.on("change",function(){p.save(n)})}(),j.TileLayer=function(a,b){this._source=a,this._tileSize=256,b=b||{},this.attribution=b.attribution,this._minZoom=parseFloat(b.minZoom)||0,this._maxZoom=parseFloat(b.maxZoom)||18,this._maxZoom<this._minZoom&&(this._maxZoom=this._minZoom),this._buffer=b.buffer||1,this._shader=new g.Shader({vertexShader:"precision mediump float;attribute vec4 aPosition;attribute vec2 aTexCoord;uniform mat4 uMatrix;varying vec2 vTexCoord;void main() {  gl_Position = uMatrix * aPosition;  vTexCoord = aTexCoord;}",fragmentShader:"precision mediump float;uniform sampler2D uTileImage;varying vec2 vTexCoord;void main() {  gl_FragColor = texture2D(uTileImage, vec2(vTexCoord.x, -vTexCoord.y));}",attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uTileImage"]}),this._tiles={}},j.TileLayer.prototype={addTo:function(a){this.map=a,a.addLayer(this),a.on("change",function(){this.update(500)}.bind(this)),a.on("resize",this.update.bind(this)),this.update()},remove:function(){this.map.removeLayer(this),clearTimeout(this._isWaiting),this.map=null},update:function(a){return this.map&&!(this._zoom<this._minZoom||this._zoom>this._maxZoom)?a?void(this._isWaiting||(this._isWaiting=setTimeout(function(){this._isWaiting=null,this._loadTiles()}.bind(this),a))):void this._loadTiles():void 0},getURL:function(a,b,c){var d={s:"abcd"[(a+b)%4],x:a,y:b,z:c};return this._source.replace(/\{(\w+)\}/g,function(a,b){return d[b]||a})},_distance2:function(a,b){var c=a[0]-b[0],d=a[1]-b[1];return c*c+d*d},_updateBounds:function(){var a=this.map,b=a.getBounds(),c=Math.round(a.getZoom()),d=Math.pow(2,this._zoom-c)/this._tileSize;this._minX=(b.minX*d<<0)-1,this._minY=(b.minY*d<<0)-1,this._maxX=Math.ceil(b.maxX*d)+1,this._maxY=Math.ceil(b.maxY*d)+1},_loadTiles:function(){var a,b,c,d,e=[],f=[this._minX+(this._maxX-this._minX)/2-.5,this._maxY+(this._maxY-this._minY)/2-.5];for(this._updateBounds(),b=this._minY;b<this._maxY;b++)for(a=this._minX;a<this._maxX;a++)c=[a,b,this._zoom].join(","),this._tiles[c]||(this._tiles[c]=new q(a,b,this._zoom),e.push({tile:this._tiles[c],dist:this._distance2([a,b],f)}));if(!(d=e.length)){e.sort(function(a,b){return a.dist-b.dist});for(var g,h=0;d>h;h++)g=e[h].tile,g.load(this.getURL(g.tileX,g.tileY,g.zoom))}this._purge()},_purge:function(){for(var a in this._tiles)this._isVisible(this._tiles[a],this._buffer)||(this._tiles[a].destroy(),delete this._tiles[a])},_isVisible:function(a,b){b=b||0;var c=a.tileX,d=a.tileY;return a.zoom===zoom&&c>=this._minX-b&&c<=this._maxX+b&&d>=this._minY-b&&d<=this._maxY+b},render:function(a){var b,c;this._shader.enable();for(var d in this._tiles)b=this._tiles[d],(c=b.getMatrix())&&(e.uniformMatrix4fv(shader.uniforms.uMatrix,!1,g.Matrix.multiply(c,a)),b.vertexBuffer.enable(),e.vertexAttribPointer(shader.attributes.aPosition,b.vertexBuffer.itemSize,e.FLOAT,!1,0,0),b.texCoordBuffer.enable(),e.vertexAttribPointer(shader.attributes.aTexCoord,b.texCoordBuffer.itemSize,e.FLOAT,!1,0,0),b.texture.enable(0),e.uniform1i(shader.uniforms.uTileImage,0),e.drawArrays(e.TRIANGLE_STRIP,0,b.vertexBuffer.numItems));this._shader.disable()},destroy:function(){this.map=null,clearTimeout(this._isWaiting);for(var a in this._tiles)this._tiles[a].destroy();this._tiles=null}};var q=function(a,b,c){this.tileX=a,this.tileY=b,this.zoom=c,this.vertexBuffer=new g.Buffer(3,new Float32Array([255,0,0,255,255,0,0,0,0,0,255,0])),this.texCoordBuffer=new g.Buffer(2,new Float32Array([1,1,1,0,0,1,0,0])),this.texture=new g.Texture};q.prototype={load:function(a){this.url=a,m.setBusy(a),this.texture.load(a,function(b){m.setIdle(a),b&&(this.isLoaded=!0)}.bind(this))},getMatrix:function(){if(this.isLoaded){var a=new g.Matrix,b=1/Math.pow(2,this.zoom-n.zoom),c=n.center;return a.scale(1.005*b,1.005*b,1),a.translate(this.tileX*r*b-c.x,this.tileY*r*b-c.y,0),a}},destroy:function(){this.vertexBuffer.destroy(),this.texCoordBuffer.destroy(),this.texture.destroy(),m.setIdle(this.url)}};var r=(Math.PI,256),s=a.document;return j}(this);"function"==typeof define?define([],GLMap):"object"==typeof exports?module.exports=GLMap:global.GLMap=GLMap;
=======
var GLMap=function(a){function b(a){return a*p/180}function c(a,b){var c=a[0]-b[0],d=a[1]-b[1];return c*c+d*d}function d(a,b,c){return Math.min(c,Math.max(a,b))}function d(a,b,c){return Math.min(c,Math.max(a,b))}function e(a,b,c){var d=b/360+.5,e=Math.min(1,Math.max(0,.5-Math.log(Math.tan(Math.PI/4+Math.PI/2*a/180))/Math.PI/2));return{x:d*c,y:e*c}}function f(a,b,c){return a/=c,b/=c,{latitude:(2*Math.atan(Math.exp(Math.PI*(1-2*b)))-Math.PI/2)*(180/Math.PI),longitude:360*a-180}}function g(a,b){return a.replace(/\{(\w+)\}/g,function(a,c){return b[c]||a})}function h(a,b,c){a.addEventListener(b,c,!1)}function i(a){a.preventDefault&&a.preventDefault(),a.returnValue=!1}function j(a,b){this._url=a,b=b||{},this._tileSize=b.tileSize||q,this._fixedZoom=b.fixedZoom,this._tiles={},this._loading={},this._shader=new l("tileplane")}function k(a,b,c,d){this.x=a,this.y=b,this.z=c,this._texture=this._createTexture(d),this._vertexBuffer=this._createBuffer(3,new Float32Array([255,255,0,255,0,0,0,255,0,0,0,0])),this._texCoordBuffer=this._createBuffer(2,new Float32Array([1,1,1,0,0,1,0,0]))}function l(a){var b=r[a];if(this.id=o.createProgram(),this.name=a,!b.src)throw new Error('missing source for shader "'+a+'"');if(this._attach(o.VERTEX_SHADER,b.src.vertex),this._attach(o.FRAGMENT_SHADER,b.src.fragment),o.linkProgram(this.id),!o.getProgramParameter(this.id,o.LINK_STATUS))throw new Error(o.getProgramParameter(this.id,o.VALIDATE_STATUS)+"\n"+o.getError());this.attributeNames=b.attributes,this.uniformNames=b.uniforms}var m=function(a,b){b=b||{},this._listeners={},this._layers=[],this._container=document.getElementById(a),this.minZoom=parseFloat(b.minZoom)||10,this.maxZoom=parseFloat(b.maxZoom)||20,this.maxZoom<this.minZoom&&(this.maxZoom=this.minZoom),this._initState(b),this._initEvents(this._container),this._initRenderer(this._container),this.setDisabled(b.disabled)};m.prototype={_initState:function(a){this._center={},this._size={width:0,height:0},a=n.load(a),this.setCenter(a.center||{latitude:52.52,longitude:13.41}),this.setZoom(a.zoom||this.minZoom),this.setRotation(a.rotation||0),this.setTilt(a.tilt||0),this.on("change",function(){n.save(this)}.bind(this)),n.save(this)},_initEvents:function(b){this._startX=0,this._startY=0,this._startRotation=0,this._startZoom=0,this._hasTouch="ontouchstart"in a,this._dragStartEvent=this._hasTouch?"touchstart":"mousedown",this._dragMoveEvent=this._hasTouch?"touchmove":"mousemove",this._dragEndEvent=this._hasTouch?"touchend":"mouseup",h(b,this._dragStartEvent,this._onDragStart.bind(this)),h(b,"dblclick",this._onDoubleClick.bind(this)),h(document,this._dragMoveEvent,this._onDragMove.bind(this)),h(document,this._dragEndEvent,this._onDragEnd.bind(this)),this._hasTouch?h(b,"gesturechange",this._onGestureChange.bind(this)):(h(b,"mousewheel",this._onMouseWheel.bind(this)),h(b,"DOMMouseScroll",this._onMouseWheel.bind(this))),h(a,"resize",this._onResize.bind(this))},_initRenderer:function(a){var b=document.createElement("CANVAS");b.style.position="absolute",b.style.pointerEvents="none",a.appendChild(b);try{o=b.getContext("experimental-webgl",{antialias:!0,depth:!0,premultipliedAlpha:!1})}catch(c){throw c}h(b,"webglcontextlost",function(a){i(a),clearInterval(this._loop)}.bind(this)),h(b,"webglcontextrestored",this._initGL.bind(this)),this._initGL()},_initGL:function(){this.setSize({width:this._container.offsetWidth,height:this._container.offsetHeight}),o.enable(o.CULL_FACE),o.enable(o.DEPTH_TEST),this._loop=setInterval(this._render.bind(this),17)},_render:function(){requestAnimationFrame(function(){o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(var a=0;a<this._layers.length;a++)this._layers[a].render(this._projection)}.bind(this))},_onDragStart:function(a){if(!(this._isDisabled||void 0!==a.button&&0!==a.button)){if(i(a),void 0!==a.touches){if(this._startRotation=this._rotation,this._startZoom=this._zoom,a.touches.length>1)return;a=a.touches[0]}this._startX=a.clientX,this._startY=a.clientY,this._isDragging=!0}},_onDragMove:function(a){if(!this._isDisabled&&this._isDragging){if(void 0!==a.touches){if(a.touches.length>1)return;a=a.touches[0]}var b=a.clientX-this._startX,c=a.clientY-this._startY,d=this._rotatePoint(b,c,this._rotation*Math.PI/180);this.setCenter(f(this._origin.x-d.x,this._origin.y-d.y,this._worldSize)),this._startX=a.clientX,this._startY=a.clientY}},_onDragEnd:function(a){if(!this._isDisabled&&this._isDragging){if(void 0!==a.touches){if(a.touches.length>1)return;a=a.touches[0]}this._isDragging=!1;var b=a.clientX-this._startX,c=a.clientY-this._startY,d=this._rotatePoint(b,c,this._rotation*Math.PI/180);this.setCenter(f(this._origin.x-d.x,this._origin.y-d.y,this._worldSize))}},_rotatePoint:function(a,b,c){return{x:Math.cos(c)*a-Math.sin(c)*b,y:Math.sin(c)*a+Math.cos(c)*b}},_onGestureChange:function(a){this._isDisabled||(i(a),this.setRotation(this._startRotation-a.rotation),this.setZoom(this._startZoom+(a.scale-1)))},_onDoubleClick:function(a){this._isDisabled||(i(a),this.setZoom(this._zoom+1,a))},_onMouseWheel:function(a){if(!this._isDisabled){i(a);var b=0;a.wheelDeltaY?b=a.wheelDeltaY:a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail);var c=.2*(b>0?1:0>b?-1:0);this.setZoom(this._zoom+c,a)}},_onResize:function(){clearTimeout(this._resizeTimer),this._resizeTimer=setTimeout(function(){var a=this._container;(this._size.width!==a.offsetWidth||this._size.height!==a.offsetHeight)&&this.setSize({width:a.offsetWidth,height:a.offsetHeight})}.bind(this),250)},_emit:function(a){if(this._listeners[a])for(var b=this._listeners[a],c=0,d=b.length;d>c;c++)b[c]()},addLayer:function(a){this._layers.push(a)},removeLayer:function(a){for(var b=0;b<this._layers.length;b++)if(this._layers[b]===a)return void this._layers[b].splice(b,1)},setDisabled:function(a){this._isDisabled=!!a},on:function(a,b){var c=this._listeners[a]||(this._listeners[a]=[]);return c.push(b),this},_setOrigin:function(a){this._origin=a},off:function(){return this},getZoom:function(){return this._zoom},setZoom:function(a,b){if(a=d(parseFloat(a),this.minZoom,this.maxZoom),this._zoom!==a){if(b){var c=this.getSize(),g=c.width/2-b.clientX,h=c.height/2-b.clientY,i=f(this._origin.x-g,this._origin.y-h,this._worldSize);this._zoom=a,this._worldSize=q*Math.pow(2,a);var j=e(i.latitude,i.longitude,this._worldSize);this._setOrigin({x:j.x+g,y:j.y+h}),this._center=f(this._origin.x,this._origin.y,this._worldSize)}else this._zoom=a,this._worldSize=q*Math.pow(2,a),this._setOrigin(e(this._center.latitude,this._center.longitude,this._worldSize));this._emit("change")}return this},getCenter:function(){return this._center},setCenter:function(a){return a.latitude=d(parseFloat(a.latitude),-90,90),a.longitude=d(parseFloat(a.longitude),-180,180),(this._center.latitude!==a.latitude||this._center.longitude!==a.longitude)&&(this._center=a,this._setOrigin(e(a.latitude,a.longitude,this._worldSize)),this._emit("change")),this},getBounds:function(){var a=e(this._center.latitude,this._center.longitude,this._worldSize),b=this.getSize(),c=b.width/2,d=b.height/2,g=f(a.x-c,a.y-d,this._worldSize),h=f(a.x+c,a.y+d,this._worldSize);return{n:g.latitude,w:g.longitude,s:h.latitude,e:h.longitude}},setSize:function(a){var b=o.canvas;return(a.width!==this._size.width||a.height!==this._size.height)&&(b.width=this._size.width=a.width,b.height=this._size.height=a.height,o.viewport(0,0,a.width,a.height),this._projection=s.perspective(20,a.width,a.height,4e4),this._emit("resize")),this},getSize:function(){return this._size},getOrigin:function(){return this._origin},getRotation:function(){return this._rotation},setRotation:function(a){return a=parseFloat(a)%360,this._rotation!==a&&(this._rotation=a,this._emit("change")),this},getTilt:function(){return this._tilt},setTilt:function(a){return a=d(parseFloat(a),0,70),this._tilt!==a&&(this._tilt=a,this._emit("change")),this},getContext:function(){return o},destroy:function(){var a=o.canvas;a.parentNode.removeChild(a),o=null,this._listeners=null;for(var b=0;b<this._layers.length;b++)this._layers[b].destroy();this._layers=null}};var n={};!function(){function a(a){if(history.replaceState){var b=[],c=a.getCenter();b.push("latitude="+c.latitude.toFixed(5)),b.push("longitude="+c.longitude.toFixed(5)),b.push("zoom="+a.getZoom().toFixed(1)),b.push("tilt="+a.getTilt().toFixed(1)),b.push("rotation="+a.getRotation().toFixed(1)),history.replaceState({},"","?"+b.join("&"))}}n.load=function(a){var b=location.search;if(b){var c={};b=b.substring(1).replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(a,b,d){b&&(c[b]=d)}),void 0!==c.latitude&&void 0!==c.longitude&&(a.center={latitude:parseFloat(c.latitude),longitude:parseFloat(c.longitude)}),void 0!==c.zoom&&(a.zoom=parseFloat(c.zoom)),void 0!==c.rotation&&(a.rotation=parseFloat(c.rotation)),void 0!==c.tilt&&(a.tilt=parseFloat(c.tilt))}return a};var b;n.save=function(c){clearTimeout(b),b=setTimeout(function(){a(c)},1e3)}}();var o,p=Math.PI,q=256,r={tileplane:{src:{vertex:"\nprecision mediump float;\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMatrix;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = uMatrix * aPosition;\n  vTexCoord = aTexCoord;\n}\n",fragment:"\nprecision mediump float;\nuniform sampler2D uTileImage;\nvarying vec2 vTexCoord;\nvoid main() {\n  vec4 texel = texture2D(uTileImage, vec2(vTexCoord.x, -vTexCoord.y));\n  gl_FragColor = texel;\n}\n"},attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uTileImage"]}};m.TileLayer=j,j.prototype={_updateTileBounds:function(){var a=this._map.getBounds(),b=this._tileSize,c=this._zoom=this._fixedZoom||Math.round(this._map.getZoom()),d=b<<c,f=e(a.n,a.w,d),g=e(a.s,a.e,d);this._tileBounds={minX:f.x/b<<0,minY:f.y/b<<0,maxX:Math.ceil(g.x/b),maxY:Math.ceil(g.y/b)}},_loadTiles:function(){var a,b,d,e,f=this._tileBounds,g=this._zoom,h=this._tiles,i=this._loading,j=[];for(b=f.minY;b<=f.maxY;b++)for(a=f.minX;a<=f.maxX;a++)d=[a,b,g].join(","),h[d]||i[d]||j.push({x:a,y:b,z:g});if(e=j.length){var k={x:f.minX+(f.maxX-f.minX-1)/2,y:f.minY+(f.maxY-f.minY-1)/2};j.sort(function(a,b){return c(b,k)-c(a,k)});for(var l=0;e>l;l++)this._loadTile(j[l].x,j[l].y,j[l].z);this._purge()}},_getURL:function(a,b,c){var d="abcd"[(a+b)%4];return g(this._url,{s:d,x:a,y:b,z:c})},_loadTile:function(a,b,c){var d=[a,b,c].join(","),e=new Image;e.crossOrigin="*",e.onload=function(){delete this._loading[d],this._tiles[d]=new k(a,b,c,e)}.bind(this),e.onerror=function(){delete this._loading[d]}.bind(this);var f={abort:function(){e.src=""}};return this._loading[d]=f,e.src=this._getURL(a,b,c),f},_purge:function(){var a,b=this._tiles,c=this._loading;for(a in b)this._isVisible(a,2)||(b[a].destroy(),delete b[a]);for(a in c)this._isVisible(a)||(c[a].abort(),delete c[a])},_isVisible:function(a,b){b=b||0;var c=this._tileSize,d=this._tileBounds,e=a.split(","),f=parseInt(e[0],10),g=parseInt(e[1],10),h=parseInt(e[2],10);return h!==this._zoom?!1:f>=d.minX-b-c&&f<=d.maxX+b&&g>=d.minY-b-c&&g<=d.maxY+b},addTo:function(a){this._map=a,a.addLayer(this),this._updateTileBounds(),this.update(),a.on("change",function(){this._updateTileBounds(),this.update(100)}.bind(this)),a.on("resize",function(){this._updateTileBounds(),this.update()}.bind(this))},remove:function(){this._map.remove(this),this._map=null},update:function(a){return a?void(this._isWaiting||(this._isWaiting=setTimeout(function(){this._isWaiting=null,this._loadTiles()}.bind(this),a))):void this._loadTiles()},render:function(a){o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);var b=this._shader.use();for(var c in this._tiles)this._isVisible(c)&&this._tiles[c].render(b,a,this._map);b.end()},destroy:function(){clearTimeout(this._isWaiting);for(var a in this._tiles)this._tiles[a].destroy();this._tiles=null;for(a in this._loading)this._loading[a].abort();this._loading=null}},k.prototype={_createTexture:function(a){var b=o.createTexture();return o.bindTexture(o.TEXTURE_2D,b),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!0),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,a),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_NEAREST),o.generateMipmap(o.TEXTURE_2D),b},_createBuffer:function(a,b){var c=o.createBuffer();return c.itemSize=a,c.numItems=b.length/a,o.bindBuffer(o.ARRAY_BUFFER,c),o.bufferData(o.ARRAY_BUFFER,b,o.STATIC_DRAW),c},render:function(a,b,c){var d=1/Math.pow(2,this.z-c.getZoom()),e=q*d,f=c.getSize(),g=c.getOrigin(),h=s.create();h=s.scale(h,1.005*d,1.005*d,1),h=s.translate(h,this.x*e-g.x,this.y*e-g.y,0),h=s.rotateZ(h,c.getRotation()),h=s.rotateX(h,c.getTilt()),h=s.translate(h,f.width/2,f.height/2,0),h=s.multiply(h,b),o.uniformMatrix4fv(a.uniforms.uMatrix,!1,new Float32Array(h)),o.bindBuffer(o.ARRAY_BUFFER,this._vertexBuffer),o.vertexAttribPointer(a.attributes.aPosition,this._vertexBuffer.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._texCoordBuffer),o.vertexAttribPointer(a.attributes.aTexCoord,this._texCoordBuffer.itemSize,o.FLOAT,!1,0,0),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this._texture),o.uniform1i(a.uniforms.uTileImage,0),o.drawArrays(o.TRIANGLE_STRIP,0,this._vertexBuffer.numItems)},destroy:function(){o.deleteBuffer(this._vertexBuffer),o.deleteBuffer(this._texCoordBuffer)}};var s={create:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},multiply:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return[c*s+d*w+e*A+f*E,c*t+d*x+e*B+f*F,c*u+d*y+e*C+f*G,c*v+d*z+e*D+f*H,g*s+h*w+i*A+j*E,g*t+h*x+i*B+j*F,g*u+h*y+i*C+j*G,g*v+h*z+i*D+j*H,k*s+l*w+m*A+n*E,k*t+l*x+m*B+n*F,k*u+l*y+m*C+n*G,k*v+l*z+m*D+n*H,o*s+p*w+q*A+r*E,o*t+p*x+q*B+r*F,o*u+p*y+q*C+r*G,o*v+p*z+q*D+r*H]},perspective:function(a,b,c,d){return[2/b,0,0,0,0,-2/c,0,0,0,40/d,-2/d,a*(-2/d),-1,1,0,1]},translate:function(a,b,c,d){return this.multiply(a,[1,0,0,0,0,1,0,0,0,0,1,0,b,c,d,1])},rotateX:function(a,c){var d=b(c),e=Math.cos(d),f=Math.sin(d);return this.multiply(a,[1,0,0,0,0,e,f,0,0,-f,e,0,0,0,0,1])},rotateY:function(a,c){var d=b(c),e=Math.cos(d),f=Math.sin(d);return this.multiply(a,[e,0,-f,0,0,1,0,0,f,0,e,0,0,0,0,1])},rotateZ:function(a,c){var d=b(c),e=Math.cos(d),f=Math.sin(d);return this.multiply(a,[e,-f,0,0,f,e,0,0,0,0,1,0,0,0,0,1])},scale:function(a,b,c,d){return this.multiply(a,[b,0,0,0,0,c,0,0,0,0,d,0,0,0,0,1])},invert:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15],r=b*g-c*f,s=b*h-d*f,t=b*i-e*f,u=c*h-d*g,v=c*i-e*g,w=d*i-e*h,x=j*o-k*n,y=j*p-l*n,z=j*q-m*n,A=k*p-l*o,B=k*q-m*o,C=l*q-m*p,D=r*C-s*B+t*A+u*z-v*y+w*x;return D?(D=1/D,[(g*C-h*B+i*A)*D,(d*B-c*C-e*A)*D,(o*w-p*v+q*u)*D,(l*v-k*w-m*u)*D,(h*z-f*C-i*y)*D,(b*C-d*z+e*y)*D,(p*t-n*w-q*s)*D,(j*w-l*t+m*s)*D,(f*B-g*z+i*x)*D,(c*z-b*B-e*x)*D,(n*v-o*t+q*r)*D,(k*t-j*v-m*r)*D,(g*y-f*A-h*x)*D,(b*A-c*y+d*x)*D,(o*s-n*u-p*r)*D,(j*u-k*s+l*r)*D]):null},invert3:function(a){var b=a[0],c=a[1],d=a[2],e=a[4],f=a[5],g=a[6],h=a[8],i=a[9],j=a[10],k=j*f-g*i,l=-j*e+g*h,m=i*e-f*h,n=b*k+c*l+d*m;return n?(n=1/n,[k*n,(-j*c+d*i)*n,(g*c-d*f)*n,l*n,(j*b-d*h)*n,(-g*b+d*e)*n,m*n,(-i*b+c*h)*n,(f*b-c*e)*n]):null},transpose:function(a){return[a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]]}};return l.prototype._attach=function(a,b){var c=o.createShader(a);if(o.shaderSource(c,b),o.compileShader(c),!o.getShaderParameter(c,o.COMPILE_STATUS))throw new Error(o.getShaderInfoLog(c));o.attachShader(this.id,c)},l.prototype.use=function(){o.useProgram(this.id);var a,b,c;if(this.attributeNames)for(this.attributes={},a=0;a<this.attributeNames.length;a++)b=this.attributeNames[a],c=o.getAttribLocation(this.id,b),0>c?console.error('could not locate attribute "'+b+'" in shader "'+this.name+'"'):(o.enableVertexAttribArray(c),this.attributes[b]=c);if(this.uniformNames)for(this.uniforms={},a=0;a<this.uniformNames.length;a++)b=this.uniformNames[a],c=o.getUniformLocation(this.id,b),0>c?console.error('could not locate uniform "'+b+'" in shader "'+this.name+'"'):this.uniforms[b]=c;return this},l.prototype.end=function(){if(o.useProgram(null),this.attributes)for(var a in this.attributes)o.disableVertexAttribArray(this.attributes[a]);this.attributes=null,this.uniforms=null},m}(this);
>>>>>>> 3e100454c285344884860fe751af5ee4bffb7b6e
